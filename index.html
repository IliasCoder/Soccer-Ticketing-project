<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎫 Plateforme de Billetterie</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
        }

        .header-text {
            text-align: center;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
        }

        /* Layout principal */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Section des matches */
        .matches-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 25px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: "⚽";
            font-size: 2.5rem;
        }

        /* Grille des matches */
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .match-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .match-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .match-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .match-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .match-teams {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .match-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .match-price {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 10px;
        }

        /* Indicateur de proximité */
        .proximity-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }

        .proximity-soon {
            background: #e74c3c;
        }

        .proximity-near {
            background: #f39c12;
        }

        .proximity-far {
            background: #27ae60;
        }

        /* Formulaires */
        .ticket-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        /* Section panier */
        .cart-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .cart-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-title::before {
            content: "🛒";
            font-size: 2rem;
        }

        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-cart-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .cart-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .cart-item-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .cart-item-details {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .cart-item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-total {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        /* Formulaire client dans le panier */
        .customer-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .customer-form h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .customer-form h3::before {
            content: "👤";
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #333;
        }

        /* États de paiement */
        .payment-state {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-radius: 50%;
            color: white;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .notification.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .external-button {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }

        /* Améliorations visuelles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            margin-right: 5px;
        }

        .badge-economic {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .badge-standard {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .badge-vip {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .price-display {
            background: rgba(39, 174, 96, 0.1);
            border: 2px solid rgba(39, 174, 96, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .price-total {
            font-weight: bold;
            font-size: 1.1rem;
            color: #27ae60;
            border-top: 1px solid rgba(39, 174, 96, 0.3);
            padding-top: 8px;
            margin-top: 8px;
        }

        /* Styles pour le formulaire de carte */
        .card-input-group {
            position: relative;
        }

        .card-type-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .form-group input.valid {
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .card-logos {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            opacity: 0.7;
        }

        .card-logo {
            width: 40px;
            height: 25px;
            background: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: #666;
        }

        .whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .whatsapp-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .whatsapp-button i {
            color: white;
            font-size: 32px;
        }

        .whatsapp-tooltip {
            position: absolute;
            right: 75px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            white-space: nowrap;
        }

        .whatsapp-button:hover .whatsapp-tooltip {
            display: block;
        }

        .external-links {
            display: flex;
            gap: 15px;
        }

        .external-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .oncf-button {
            background-color: #0066cc;
            color: white;
            border: 2px solid #0066cc;
        }

        .oncf-button:hover {
            background-color: white;
            color: #0066cc;
        }

        .booking-button {
            background-color: #003580;
            color: white;
            border: 2px solid #003580;
        }

        .booking-button:hover {
            background-color: white;
            color: #003580;
        }

        .external-button i {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎫 Plateforme de Billetterie</h1>
            <div class="header-content">
                <div class="header-text">
                    <p>Réservez vos tickets pour les meilleurs événements sportifs</p>
                </div>
                <div class="external-links">
                    <a href="https://www.oncf.ma" target="_blank" class="external-button oncf-button">
                        <i class="fas fa-train"></i>
                        Réserver Train
                    </a>
                    <a href="https://www.booking.com" target="_blank" class="external-button booking-button">
                        <i class="fas fa-hotel"></i>
                        Réserver Hôtel
                    </a>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Section des matches -->
            <div class="matches-section">
                <h2 class="section-title">Matches Disponibles</h2>
                <div id="matches-container" class="matches-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des matches...</p>
                    </div>
                </div>
            </div>

            <!-- Section du panier -->
            <div class="cart-section">
                <h2 class="cart-title">Mon Panier</h2>
                <div id="cart-container">
                    <div class="empty-cart">
                        <div class="empty-cart-icon">🛒</div>
                        <p>Votre panier est vide</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Ajoutez des tickets pour commencer</p>
                    </div>
                </div>

                <!-- Formulaire client -->
                <div id="customer-form" class="customer-form hidden">
                    <h3>Vos informations</h3>
                    <div class="form-group">
                        <label for="customer-name">Nom complet *</label>
                        <input type="text" id="customer-name" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-email">Email *</label>
                        <input type="email" id="customer-email" placeholder="votre@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">Téléphone</label>
                        <input type="tel" id="customer-phone" placeholder="Votre numéro de téléphone">
                    </div>
                </div>

                <!-- Total et checkout -->
                <div id="cart-total-section" class="hidden">
                    <div class="cart-total">
                        <div class="total-amount">
                            Total: <span id="cart-total-amount">0.00€</span>
                        </div>
                        <button id="checkout-btn" class="btn btn-success btn-full">
                            Procéder au paiement 💳
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de paiement -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            
            <!-- Formulaire de paiement -->
            <div id="payment-form">
                <h2 style="margin-bottom: 20px; color: #333;">💳 Finaliser votre commande</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Récapitulatif -->
                    <div>
                        <h3 style="margin-bottom: 15px; color: #333;">📋 Récapitulatif</h3>
                        <div id="order-summary" style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                    </div>
                    
                    <!-- Informations client -->
                    <div>
                        <h3 style="margin-bottom: 15px; color: #333;">👤 Vos informations</h3>
                        <div id="customer-info-display" style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Formulaire de carte bancaire -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px;">
                        💳 Informations de paiement
                    </h3>
                    
                    <form id="card-form">
                        <div class="form-group">
                            <label for="card-number">Numéro de carte *</label>
                            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                            <div id="card-type" style="margin-top: 5px; font-size: 0.9rem; color: #666;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="card-name">Nom sur la carte *</label>
                            <input type="text" id="card-name" placeholder="JEAN DUPONT" style="text-transform: uppercase;" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card-expiry">Date d'expiration *</label>
                                <input type="text" id="card-expiry" placeholder="MM/AA" maxlength="5" required>
                            </div>
                            <div class="form-group">
                                <label for="card-cvv">Code CVV *</label>
                                <input type="text" id="card-cvv" placeholder="123" maxlength="4" required>
                            </div>
                        </div>
                        
                        <!-- Adresse de facturation -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <h4 style="margin-bottom: 15px; color: #333;">📍 Adresse de facturation</h4>
                            
                            <div class="form-group">
                                <label for="billing-address">Adresse *</label>
                                <input type="text" id="billing-address" placeholder="123 Rue de la Paix" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="billing-city">Ville *</label>
                                    <input type="text" id="billing-city" placeholder="Paris" required>
                                </div>
                                <div class="form-group">
                                    <label for="billing-postal">Code postal *</label>
                                    <input type="text" id="billing-postal" placeholder="75001" maxlength="5" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="billing-country">Pays *</label>
                                <select id="billing-country" required>
                                    <option value="FR" selected>France</option>
                                    <option value="BE">Belgique</option>
                                    <option value="CH">Suisse</option>
                                    <option value="CA">Canada</option>
                                    <option value="US">États-Unis</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Logos des cartes acceptées -->
                        <div class="card-logos">
                            <div class="card-logo" style="background: #1a1f71; color: white;">VISA</div>
                            <div class="card-logo" style="background: #eb001b; color: white;">MC</div>
                            <div class="card-logo" style="background: #006fcf; color: white;">AMEX</div>
                            <div class="card-logo" style="background: #ff5f00; color: white;">DISC</div>
                        </div>
                        
                        <!-- Sécurité SSL -->
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 10px; background: rgba(39, 174, 96, 0.1); border-radius: 8px;">
                            <span style="color: #27ae60; font-size: 1.2rem;">🔒</span>
                            <small style="color: #27ae60; font-weight: 600;">Paiement sécurisé SSL 256-bit</small>
                        </div>
                    </form>
                </div>

                <div style="text-align: center;">
                    <button id="confirm-payment" class="btn btn-success" style="padding: 15px 40px; font-size: 1.1rem;">
                        Confirmer le paiement 🔒
                    </button>
                    <button id="cancel-payment" class="btn" style="background: #95a5a6; color: white; margin-left: 15px;">
                        Annuler
                    </button>
                </div>
            </div>

            <!-- État de traitement -->
            <div id="processing-state" class="payment-state hidden">
                <div class="spinner"></div>
                <h3>Traitement en cours...</h3>
                <p>Vérification des informations de carte...</p>
                <div id="processing-steps" style="margin-top: 20px; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto;">
                    <div class="processing-step" data-step="1">
                        <span class="step-icon">⏳</span> Validation des informations...
                    </div>
                    <div class="processing-step" data-step="2">
                        <span class="step-icon">⏳</span> Vérification auprès de la banque...
                    </div>
                    <div class="processing-step" data-step="3">
                        <span class="step-icon">⏳</span> Finalisation de la commande...
                    </div>
                </div>
            </div>

            <!-- État de succès -->
            <div id="success-state" class="payment-state hidden">
                <div class="success-icon">✓</div>
                <h3>Paiement confirmé !</h3>
                <p>Votre commande a été traitée avec succès.</p>
                
                <!-- Détails de la commande -->
                <div id="order-details" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left;">
                </div>
                
                <!-- Section des billets -->
                <div id="ticket-downloads" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left;">
                    <h3 style="color: #333; margin-bottom: 15px;">Vos billets</h3>
                    <div id="ticket-buttons-container">
                        <!-- Les boutons de téléchargement seront ajoutés ici -->
                    </div>
                </div>
                
                <button id="close-success" class="btn btn-primary" style="margin-top: 20px;">Fermer</button>
            </div>

            <!-- État d'erreur -->
            <div id="error-state" class="payment-state hidden">
                <div style="width: 80px; height: 80px; background: #e74c3c; border-radius: 50%; color: white; font-size: 40px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">✗</div>
                <h3>Erreur de paiement</h3>
                <p id="error-message">Une erreur est survenue lors du traitement de votre paiement.</p>
                <button id="retry-payment" class="btn btn-primary" style="margin-right: 10px;">Réessayer</button>
                <button id="close-error" class="btn" style="background: #95a5a6; color: white;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <div class="whatsapp-button" onclick="shareTicketOnWhatsApp()">
        <i class="fab fa-whatsapp"></i>
        <span class="whatsapp-tooltip">Partager sur WhatsApp</span>
    </div>

    <nav class="navbar">
        <div class="logo">
            <img src="assets/logo.png" alt="Logo">
            <span>Billetterie Sportive</span>
        </div>
        <div class="external-links">
            <a href="https://www.oncf.ma" target="_blank" class="external-button oncf-button">
                <i class="fas fa-train"></i>
                <span>Train ONCF</span>
            </a>
            <a href="https://www.booking.com" target="_blank" class="external-button booking-button">
                <i class="fas fa-hotel"></i>
                <span>Réserver Hôtel</span>
            </a>
        </div>
        <div class="cart-icon" onclick="toggleCart()">
            <!-- ... existing cart icon code ... -->
        </div>
    </nav>

    <script>
        // Variables globales
        let matches = [];
        let categories = [];
        let sections = [];
        let cart = [];

        // Test data for debugging
        const testMatch = {
            matchId: 1,
            matchName: "PSG vs Real Madrid",
            matchDate: "2024-06-15",
            matchTime: "20:45",
            venue: "Parc des Princes",
            categoryName: "VIP",
            sectionName: "Tribune Présidentielle",
            seatNumber: "A123",
            price: 150.00,
            quantity: 1
        };

        // Éléments DOM
        const matchesContainer = document.getElementById('matches-container');
        const cartContainer = document.getElementById('cart-container');
        const customerForm = document.getElementById('customer-form');
        const cartTotalSection = document.getElementById('cart-total-section');
        const cartTotalAmount = document.getElementById('cart-total-amount');
        const checkoutBtn = document.getElementById('checkout-btn');
        const paymentModal = document.getElementById('payment-modal');
        const notification = document.getElementById('notification');

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Add test data to cart for debugging
            cart.push(testMatch);
            saveCartToStorage();
            
            loadData();
            loadCartFromStorage();
            setupCardValidation();
            renderCart(); // Make sure cart is rendered
        });

        // Configuration de la validation des cartes
        function setupCardValidation() {
            const cardNumber = document.getElementById('card-number');
            const cardExpiry = document.getElementById('card-expiry');
            const cardCvv = document.getElementById('card-cvv');
            const cardName = document.getElementById('card-name');

            // Formatage du numéro de carte
            cardNumber.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                
                if (formattedValue.length <= 19) {
                    e.target.value = formattedValue;
                }

                // Détection du type de carte
                detectCardType(value);
                validateCardNumber(value);
            });

            // Formatage de la date d'expiration
            cardExpiry.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
                validateExpiry(value);
            });

            // Validation CVV
            cardCvv.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value;
                validateCvv(value);
            });

            // Formatage du nom (majuscules)
            cardName.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                validateCardName(e.target.value);
            });
        }

        // Détection du type de carte
        function detectCardType(number) {
            const cardTypeElement = document.getElementById('card-type');
            let cardType = '';
            let icon = '';

            if (number.match(/^4/)) {
                cardType = 'Visa';
                icon = '💳';
            } else if (number.match(/^5[1-5]/)) {
                cardType = 'Mastercard';
                icon = '💳';
            } else if (number.match(/^3[47]/)) {
                cardType = 'American Express';
                icon = '💳';
            } else if (number.match(/^6/)) {
                cardType = 'Discover';
                icon = '💳';
            }

            if (cardType) {
                cardTypeElement.innerHTML = `${icon} ${cardType}`;
                cardTypeElement.style.color = '#27ae60';
            } else {
                cardTypeElement.innerHTML = '';
            }
        }

        // Validation du numéro de carte (algorithme de Luhn simplifié)
        function validateCardNumber(number) {
            const cardNumberInput = document.getElementById('card-number');
            
            if (number.length < 13 || number.length > 19) {
                setFieldState(cardNumberInput, 'error');
                return false;
            }

            // Validation basique (pour la démo)
            if (number.length >= 13) {
                setFieldState(cardNumberInput, 'valid');
                return true;
            }

            setFieldState(cardNumberInput, 'error');
            return false;
        }

        // Validation de la date d'expiration
        function validateExpiry(expiry) {
            const expiryInput = document.getElementById('card-expiry');
            
            if (expiry.length !== 5) {
                setFieldState(expiryInput, 'error');
                return false;
            }

            const [month, year] = expiry.split('/');
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear() % 100;
            const currentMonth = currentDate.getMonth() + 1;

            const expMonth = parseInt(month);
            const expYear = parseInt(year);

            if (expMonth < 1 || expMonth > 12) {
                setFieldState(expiryInput, 'error');
                return false;
            }

            if (expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
                setFieldState(expiryInput, 'error');
                return false;
            }

            setFieldState(expiryInput, 'valid');
            return true;
        }

        // Validation CVV
        function validateCvv(cvv) {
            const cvvInput = document.getElementById('card-cvv');
            
            if (cvv.length >= 3 && cvv.length <= 4) {
                setFieldState(cvvInput, 'valid');
                return true;
            }

            setFieldState(cvvInput, 'error');
            return false;
        }

        // Validation du nom sur la carte
        function validateCardName(name) {
            const nameInput = document.getElementById('card-name');
            
            if (name.length >= 2) {
                setFieldState(nameInput, 'valid');
                return true;
            }

            setFieldState(nameInput, 'error');
            return false;
        }

        // Définir l'état visuel d'un champ
        function setFieldState(input, state) {
            input.classList.remove('error', 'valid');
            if (state !== 'neutral') {
                input.classList.add(state);
            }
        }

        // Validation complète du formulaire de carte
        function validateCardForm() {
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvv = document.getElementById('card-cvv').value;
            const cardName = document.getElementById('card-name').value;
            const billingAddress = document.getElementById('billing-address').value;
            const billingCity = document.getElementById('billing-city').value;
            const billingPostal = document.getElementById('billing-postal').value;

            const errors = [];

            if (!validateCardNumber(cardNumber)) {
                errors.push('Numéro de carte invalide');
            }

            if (!validateExpiry(cardExpiry)) {
                errors.push('Date d\'expiration invalide');
            }

            if (!validateCvv(cardCvv)) {
                errors.push('Code CVV invalide');
            }

            if (!validateCardName(cardName)) {
                errors.push('Nom sur la carte requis');
            }

            if (!billingAddress.trim()) {
                errors.push('Adresse de facturation requise');
            }

            if (!billingCity.trim()) {
                errors.push('Ville requise');
            }

            if (!billingPostal.trim() || billingPostal.length < 5) {
                errors.push('Code postal invalide');
            }

            return errors;
        }

        // Chargement des données
        async function loadData() {
            try {
                await Promise.all([
                    loadMatches(),
                    loadCategories(),
                    loadSections()
                ]);
                renderMatches();
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                showNotification('Erreur lors du chargement des données', 'error');
            }
        }

        async function loadMatches() {
            try {
                const response = await fetch('matches_simple.php');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    matches = data.matches;
                    console.log(`${data.count} matches chargés depuis la base de données`);
                    showNotification(`${data.count} matches chargés avec succès!`, 'success');
                } else {
                    throw new Error(data.error || 'Erreur lors du chargement des matches');
                }
            } catch (error) {
                console.error('Erreur chargement matches:', error);
                showNotification('Erreur de connexion à la base de données. Vérifiez votre configuration.', 'error');
                
                // Données de fallback pour les tests
                matches = [
                    {
                        id: 1,
                        home_team: 'PSG',
                        away_team: 'Marseille',
                        match_date: '2024-12-15',
                        match_time: '20:00',
                        venue: 'Parc des Princes',
                        price: 45.00,
                        days_until_match: 5,
                        available: true,
                        price_multiplier: 1.5
                    }
                ];
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('categories.php');
                if (!response.ok) throw new Error('Erreur réseau');
                categories = await response.json();
            } catch (error) {
                console.error('Erreur chargement catégories:', error);
                // Données de fallback
                categories = [
                    { id: 'economic', name: 'Economic', base_price: 15.00, price_multiplier: 1.0 },
                    { id: 'standard', name: 'Standard', base_price: 25.00, price_multiplier: 1.5 },
                    { id: 'vip', name: 'VIP', base_price: 50.00, price_multiplier: 2.5 }
                ];
            }
        }

        async function loadSections() {
            try {
                const response = await fetch('sections.php');
                if (!response.ok) throw new Error('Erreur réseau');
                sections = await response.json();
            } catch (error) {
                console.error('Erreur chargement sections:', error);
                // Données de fallback
                sections = [
                    { id: 'north', name: 'Tribune Nord', seats: 'A1,A2,A3,B1,B2,B3' },
                    { id: 'south', name: 'Tribune Sud', seats: 'C1,C2,C3,D1,D2,D3' },
                    { id: 'east', name: 'Tribune Est', seats: 'E1,E2,E3,F1,F2,F3' },
                    { id: 'west', name: 'Tribune Ouest', seats: 'G1,G2,G3,H1,H2,H3' }
                ];
            }
        }

        // Rendu des matches
        function renderMatches() {
            if (matches.length === 0) {
                matchesContainer.innerHTML = `
                    <div class="loading">
                        <p>Aucun match disponible pour le moment.</p>
                    </div>
                `;
                return;
            }

            matchesContainer.innerHTML = '';
            matches.forEach(match => {
                if (!match.available) return; // Ne pas afficher les matches passés
                
                const matchCard = document.createElement('div');
                matchCard.className = 'match-card';
                
                const matchDate = new Date(match.match_date);
                const formattedDate = matchDate.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Indicateur de proximité
                let proximityClass = 'proximity-far';
                let proximityText = 'Disponible';
                
                if (match.days_until_match <= 7) {
                    proximityClass = 'proximity-soon';
                    proximityText = 'Bientôt !';
                } else if (match.days_until_match <= 30) {
                    proximityClass = 'proximity-near';
                    proximityText = 'Approche';
                }

                matchCard.innerHTML = `
                    <div class="proximity-indicator ${proximityClass}">${proximityText}</div>
                    <div class="match-header">
                        <div class="match-teams">${match.home_team} vs ${match.away_team}</div>
                        <div class="match-price">À partir de ${parseFloat(match.price).toFixed(2)}€</div>
                    </div>
                    
                    <div class="match-info">
                        <div class="info-item">
                            <span>📅</span>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="info-item">
                            <span>⏰</span>
                            <span>${match.match_time}</span>
                        </div>
                        <div class="info-item">
                            <span>🏟️</span>
                            <span>${match.venue}</span>
                        </div>
                        <div class="info-item">
                            <span>⏱️</span>
                            <span>Dans ${match.days_until_match} jours</span>
                        </div>
                    </div>

                    <form class="ticket-form" data-match-id="${match.id}">
                        <div class="form-group">
                            <label>Catégorie de ticket</label>
                            <select class="category-select" required>
                                <option value="">Choisir une catégorie</option>
                                ${categories.map(cat => 
                                    `<option value="${cat.id}" data-base="${cat.base_price}" data-multiplier="${cat.price_multiplier}">${cat.name} (${cat.base_price}€)</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Section du stade</label>
                            <select class="section-select" required>
                                <option value="">Choisir une section</option>
                                ${sections.map(section => 
                                    `<option value="${section.id}">${section.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group seat-group hidden">
                            <label>Numéro de place</label>
                            <input type="text" class="seat-input" placeholder="Ex: A15, B23..." required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Quantité</label>
                                <input type="number" class="quantity-input" value="1" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-full">
                                    Ajouter au panier 🛒
                                </button>
                            </div>
                        </div>
                        
                        <div class="price-display hidden">
                            <div class="price-row">
                                <span>Prix unitaire:</span>
                                <span class="unit-price">0.00€</span>
                            </div>
                            <div class="price-row price-total">
                                <span>Total:</span>
                                <span class="total-price">0.00€</span>
                            </div>
                        </div>
                    </form>
                `;

                // Ajouter les événements
                setupMatchCardEvents(matchCard, match);
                matchesContainer.appendChild(matchCard);
            });
        }

        function setupMatchCardEvents(matchCard, match) {
            const form = matchCard.querySelector('.ticket-form');
            const categorySelect = matchCard.querySelector('.category-select');
            const sectionSelect = matchCard.querySelector('.section-select');
            const seatGroup = matchCard.querySelector('.seat-group');
            const seatInput = matchCard.querySelector('.seat-input');
            const quantityInput = matchCard.querySelector('.quantity-input');
            const priceDisplay = matchCard.querySelector('.price-display');
            const unitPrice = matchCard.querySelector('.unit-price');
            const totalPrice = matchCard.querySelector('.total-price');

            // Événements
            categorySelect.addEventListener('change', function() {
                updatePriceDisplay();
                priceDisplay.classList.toggle('hidden', !categorySelect.value);
            });

            sectionSelect.addEventListener('change', function() {
                if (sectionSelect.value) {
                    seatGroup.classList.remove('hidden');
                    seatInput.disabled = false;
                } else {
                    seatGroup.classList.add('hidden');
                    seatInput.disabled = true;
                }
            });

            quantityInput.addEventListener('change', updatePriceDisplay);

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                handleAddToCart(match, form);
            });

            function updatePriceDisplay() {
                if (!categorySelect.value) return;

                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                const basePrice = parseFloat(selectedOption.dataset.base);
                const multiplier = parseFloat(selectedOption.dataset.multiplier);
                
                // Prix de base de la catégorie * multiplicateur de proximité du match
                const finalPrice = basePrice * (match.price_multiplier || 1);
                const quantity = parseInt(quantityInput.value);
                const total = finalPrice * quantity;

                unitPrice.textContent = `${finalPrice.toFixed(2)}€`;
                totalPrice.textContent = `${total.toFixed(2)}€`;
            }
        }

        // Gestion du panier
        function handleAddToCart(match, form) {
            const categorySelect = form.querySelector('.category-select');
            const sectionId = form.querySelector('.section-select').value;
            const seatNumber = form.querySelector('.seat-input').value.trim();
            const quantity = parseInt(form.querySelector('.quantity-input').value);

            if (!categorySelect.value || !sectionId || !seatNumber) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }

            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            const categoryId = categorySelect.value;
            const categoryName = selectedOption.text.split(' ')[0];
            const basePrice = parseFloat(selectedOption.dataset.base);
            const section = sections.find(s => s.id === sectionId);

            if (!section) {
                showNotification('Erreur lors de l\'ajout au panier', 'error');
                return;
            }

            // Prix final = prix de base de la catégorie * multiplicateur de proximité du match
            const finalPrice = basePrice * (match.price_multiplier || 1);

            // Vérifier si l'article existe déjà
            const existingIndex = cart.findIndex(item => 
                item.matchId == match.id && 
                item.categoryId === categoryId && 
                item.seatNumber === seatNumber
            );

            if (existingIndex >= 0) {
                cart[existingIndex].quantity += quantity;
            } else {
                cart.push({
                    matchId: match.id,
                    matchName: `${match.home_team} vs ${match.away_team}`,
                    matchDate: match.match_date,
                    matchTime: match.match_time,
                    venue: match.venue,
                    categoryId: categoryId,
                    categoryName: categoryName,
                    sectionId: sectionId,
                    sectionName: section.name,
                    seatNumber: seatNumber,
                    quantity: quantity,
                    price: finalPrice
                });
            }

            saveCartToStorage();
            renderCart();
            showNotification('Ticket ajouté au panier avec succès!', 'success');

            // Réinitialiser le formulaire
            form.reset();
            form.querySelector('.price-display').classList.add('hidden');
            form.querySelector('.seat-group').classList.add('hidden');
        }

        function renderCart() {
            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">🛒</div>
                        <p>Votre panier est vide</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Ajoutez des tickets pour commencer</p>
                    </div>
                `;
                customerForm.classList.add('hidden');
                cartTotalSection.classList.add('hidden');
                return;
            }

            let cartHTML = '';
            let totalAmount = 0;

            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                totalAmount += subtotal;

                cartHTML += `
                    <div class="cart-item">
                        <div class="cart-item-header">${item.matchName}</div>
                        <div class="cart-item-details">
                            <span class="badge badge-${item.categoryId}">${item.categoryName}</span>
                            ${item.sectionName} - Place ${item.seatNumber}<br>
                            <small>📅 ${new Date(item.matchDate).toLocaleDateString('fr-FR')} à ${item.matchTime}</small>
                        </div>
                        <div class="cart-item-actions">
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateQuantity(${index}, ${item.quantity - 1})">-</button>
                                <span style="margin: 0 10px; font-weight: bold;">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateQuantity(${index}, ${item.quantity + 1})">+</button>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #27ae60;">${subtotal.toFixed(2)}€</div>
                                <small>${item.price.toFixed(2)}€ × ${item.quantity}</small>
                                <br>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem; margin-top: 5px;" onclick="removeFromCart(${index})">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            cartContainer.innerHTML = cartHTML;
            cartTotalAmount.textContent = `${totalAmount.toFixed(2)}€`;
            customerForm.classList.remove('hidden');
            cartTotalSection.classList.remove('hidden');
        }

        function updateQuantity(index, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }
            cart[index].quantity = newQuantity;
            saveCartToStorage();
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCartToStorage();
            renderCart();
            showNotification('Article supprimé du panier', 'success');
        }

        function saveCartToStorage() {
            localStorage.setItem('ticketCart', JSON.stringify(cart));
        }

        function loadCartFromStorage() {
            const savedCart = localStorage.getItem('ticketCart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                    renderCart();
                } catch (e) {
                    console.error('Erreur chargement panier:', e);
                    cart = [];
                }
            }
        }

        // Gestion du paiement
        checkoutBtn.addEventListener('click', function() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerEmail = document.getElementById('customer-email').value.trim();

            if (!customerName || !customerEmail) {
                showNotification('Veuillez remplir vos informations avant de continuer', 'error');
                return;
            }

            if (!isValidEmail(customerEmail)) {
                showNotification('Veuillez entrer une adresse email valide', 'error');
                return;
            }

            showPaymentModal();
        });

        function showPaymentModal() {
            // Préparer le récapitulatif
            let summaryHTML = '';
            let total = 0;

            cart.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                summaryHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${item.matchName}</strong><br>
                            <small>${item.categoryName} - ${item.sectionName} - Place ${item.seatNumber}</small><br>
                            <small>Quantité: ${item.quantity}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${subtotal.toFixed(2)}€</strong>
                        </div>
                    </div>
                `;
            });

            summaryHTML += `
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; color: #27ae60; margin-top: 15px; padding-top: 15px; border-top: 2px solid #27ae60;">
                    <span>Total:</span>
                    <span>${total.toFixed(2)}€</span>
                </div>
            `;

            document.getElementById('order-summary').innerHTML = summaryHTML;

            // Afficher les informations client
            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;

            document.getElementById('customer-info-display').innerHTML = `
                <p><strong>Nom:</strong> ${customerName}</p>
                <p><strong>Email:</strong> ${customerEmail}</p>
                ${customerPhone ? `<p><strong>Téléphone:</strong> ${customerPhone}</p>` : ''}
            `;

            paymentModal.style.display = 'block';
        }

        // Événements du modal
        document.querySelector('.close-modal').addEventListener('click', function() {
            paymentModal.style.display = 'none';
        });

        document.getElementById('cancel-payment').addEventListener('click', function() {
            paymentModal.style.display = 'none';
        });

        document.getElementById('confirm-payment').addEventListener('click', function() {
            processPayment();
        });

        document.getElementById('close-success').addEventListener('click', function() {
            paymentModal.style.display = 'none';
            resetPaymentModal();
        });

        document.getElementById('retry-payment').addEventListener('click', function() {
            resetPaymentModal();
        });

        document.getElementById('close-error').addEventListener('click', function() {
            paymentModal.style.display = 'none';
            resetPaymentModal();
        });

        async function processPayment() {
            // Valider le formulaire de carte
            const cardErrors = validateCardForm();
            if (cardErrors.length > 0) {
                showNotification(cardErrors[0], 'error');
                return;
            }

            // Masquer le formulaire et afficher le traitement
            document.getElementById('payment-form').style.display = 'none';
            document.getElementById('processing-state').classList.remove('hidden');

            // Animation des étapes de traitement
            await simulateProcessingSteps();

            try {
                // Get customer information
                const customerName = document.getElementById('customer-name').value;
                const customerEmail = document.getElementById('customer-email').value;
                const cardNumber = document.getElementById('card-number').value;
                const totalAmount = cart.reduce((total, item) => total + (item.price * item.quantity), 0);

                // Prepare payment data
                const paymentData = {
                    customerInfo: {
                        username: customerName,
                        email: customerEmail,
                        phone: document.getElementById('customer-phone')?.value || ''
                    },
                    cartItems: cart.map(item => ({
                        matchId: item.matchId,
                        categoryId: item.categoryId || 1,
                        sectionId: item.sectionId || 1,
                        seatNumber: item.seatNumber,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    totalAmount: totalAmount,
                    paymentMethod: 'card',
                    cardInfo: {
                        number: cardNumber.replace(/\s/g, ''),
                        expiry: document.getElementById('card-expiry').value,
                        cvv: document.getElementById('card-cvv').value,
                        name: document.getElementById('card-name').value
                    }
                };

                console.log('Sending payment data:', paymentData);

                // Process payment with backend
                const paymentResponse = await fetch('payment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (!paymentResponse.ok) {
                    throw new Error(`Payment failed: ${paymentResponse.status}`);
                }

                const paymentResult = await paymentResponse.json();
                console.log('Payment result:', paymentResult);

                if (!paymentResult.success) {
                    throw new Error(paymentResult.error || 'Payment failed');
                }

                // Generate PDF tickets
                const ticketFiles = [];
                for (const item of cart) {
                    console.log('Processing cart item:', item);

                    const ticketData = {
                        orderId: paymentResult.orderId,
                        matchId: item.matchId,
                        matchName: item.matchName,
                        matchDate: new Date(item.matchDate).toLocaleDateString('fr-FR'),
                        matchTime: item.matchTime,
                        venue: item.venue || 'Stade Principal',
                        customerName: customerName,
                        categoryName: item.categoryName,
                        sectionName: item.sectionName,
                        seatNumber: item.seatNumber,
                        price: item.price.toFixed(2)
                    };

                    console.log('Sending ticket data to server:', ticketData);

                    try {
                        const pdfResponse = await fetch('generate_ticket_pdf.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(ticketData)
                        });

                        const rawResponse = await pdfResponse.clone().text();
                        console.log('Raw PDF generation response:', rawResponse);

                        try {
                            const pdfResult = JSON.parse(rawResponse);
                            console.log('Parsed PDF generation result:', pdfResult);
                            
                            if (pdfResult.success) {
                                ticketFiles.push({
                                    filename: pdfResult.filename,
                                    matchName: item.matchName,
                                    seatNumber: item.seatNumber
                                });
                                console.log('Added ticket file:', pdfResult.filename);
                                
                                // Open PDF in new tab immediately
                                window.open(`generate_ticket_pdf.php?action=view&filename=${encodeURIComponent(pdfResult.filename)}`, '_blank');
                            } else {
                                console.error('Failed to generate PDF:', pdfResult.message);
                                showNotification('Erreur lors de la génération du billet: ' + pdfResult.message, 'error');
                            }
                        } catch (jsonError) {
                            console.error('Error parsing PDF response:', jsonError);
                            console.log('Invalid JSON response:', rawResponse);
                            showNotification('Erreur lors de la génération du billet: Réponse invalide', 'error');
                        }
                    } catch (pdfError) {
                        console.error('Network error generating PDF ticket:', pdfError);
                        showNotification('Erreur réseau lors de la génération du billet', 'error');
                    }
                }

                // Show success state
                document.getElementById('processing-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');

                // Update order details
                const orderDetails = document.getElementById('order-details');
                orderDetails.style.display = 'block';
                orderDetails.innerHTML = `
                    <p><strong>Numéro de commande:</strong> #${paymentResult.orderId}</p>
                    <p><strong>Client:</strong> ${customerName}</p>
                    <p><strong>Email:</strong> ${customerEmail}</p>
                    <p><strong>Montant:</strong> ${totalAmount.toFixed(2)}€</p>
                    <p><strong>Carte utilisée:</strong> ${cardNumber.replace(/\d/g, '*')}</p>
                    <p><strong>Statut:</strong> <span style="color: #27ae60;">Confirmé</span></p>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString('fr-FR')} ${new Date().toLocaleTimeString('fr-FR')}</p>
                `;

                // Update ticket downloads section
                const ticketButtonsContainer = document.getElementById('ticket-buttons-container');
                ticketButtonsContainer.innerHTML = '';
                
                ticketFiles.forEach(ticket => {
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'ticket-download-item';
                    ticketDiv.innerHTML = `
                        <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 10px 0;">${ticket.matchName}</h4>
                            <p style="margin: 0 0 10px 0;">Place: ${ticket.seatNumber}</p>
                            <div style="display: flex; gap: 10px;">
                                <a href="download_tickets.php?order=${paymentResult.orderId}&download=${ticket.filename}" 
                                   class="btn btn-primary" style="flex: 1;">
                                    <i class="fas fa-download"></i> Télécharger
                                </a>
                                <button onclick="sendTicketByEmail('${ticket.filename}', '${customerEmail}')" 
                                        class="btn btn-success" style="flex: 1;">
                                    <i class="fas fa-envelope"></i> Envoyer par email
                                </button>
                            </div>
                        </div>
                    `;
                    ticketButtonsContainer.appendChild(ticketDiv);
                });

                // Vider le panier
                cart = [];
                saveCartToStorage();
                renderCart();

                showNotification('Commande confirmée avec succès! Vos tickets sont disponibles ci-dessous.', 'success');

            } catch (error) {
                console.error('Payment process error:', error);
                document.getElementById('processing-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message || "Une erreur est survenue lors du traitement du paiement.";
            }
        }

        // Simulation des étapes de traitement
        async function simulateProcessingSteps() {
            const steps = document.querySelectorAll('.processing-step');
            
            for (let i = 0; i < steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                steps[i].querySelector('.step-icon').textContent = '✅';
                steps[i].style.color = '#27ae60';
            }
            
            // Add extra delay for better user experience
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        function resetPaymentModal() {
            document.getElementById('payment-form').style.display = 'block';
            document.getElementById('processing-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            
            // Réinitialiser les étapes de traitement
            const steps = document.querySelectorAll('.processing-step');
            steps.forEach(step => {
                step.querySelector('.step-icon').textContent = '⏳';
                step.style.color = '#666';
            });
        }

        // Utilitaires
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Fermer le modal en cliquant à l'extérieur
        window.addEventListener('click', function(event) {
            if (event.target === paymentModal) {
                paymentModal.style.display = 'none';
            }
        });

        // Styles CSS pour les étapes de traitement
        const style = document.createElement('style');
        style.textContent = `
            .processing-step {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
                color: #666;
                transition: color 0.3s ease;
            }
            
            .step-icon {
                width: 20px;
                text-align: center;
            }
        `;
        document.head.appendChild(style);

        function shareTicketOnWhatsApp() {
            // Get the current ticket URL or generate a shareable link
            const ticketUrl = window.location.href;
            const message = encodeURIComponent("Voici mon billet pour le match ! 🎫⚽ " + ticketUrl);
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        // Ajouter la fonction d'envoi par email
        async function sendTicketByEmail(filename, email) {
            try {
                const response = await fetch('send_ticket_email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: filename,
                        email: email
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Ticket envoyé par email avec succès!', 'success');
                } else {
                    throw new Error(result.message || 'Erreur lors de l\'envoi de l\'email');
                }
            } catch (error) {
                console.error('Error sending ticket by email:', error);
                showNotification('Erreur lors de l\'envoi de l\'email: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
